{"0": {"author": "Rina", "date": "1690830755940", "content": "Hi,\nI am a bit confused about how to solve the following error CircuitError: The Program is locked, no more Commands can be appended to it. I think I understand why the error happens but  I can\u2019t come up with a way to run the circuit iteratively for a variational algorithm and avoid this error.  The answer here 1 for sampling makes sense. But what about the case when you want to run the circuit iteratively with a new parameter? I tried to eng.reset()  at the end of for loop but it didn\u2019t help.\nI\u2019d appreciate it if you could point out what I am missing here.\nimport strawberryfields as sf\nfrom strawberryfields.ops import *\n\nshots=2\nprog = sf.Program(2)\nx1 = 0.4\nx2 = 0.5\nparam=[0.1, 0.4, 0.9]\nsteps=3\n\n\neng = sf.Engine(\"fock\", backend_options={\"cutoff_dim\": 4})\n\ndef run_circuit(param):\n\n    with prog.context as q:\n\n        Squeezed(x1) | q[0]\n        Squeezed(x2) | q[1]\n\n        Zgate(-2*param) | q[0]\n        CZgate(-2*param) | (q[0],q[1])\n\n        MeasureHomodyne(0.0) | q[0]\n    return \n\nfor j in range(steps):\n    run_circuit(param[j])\n    \n    result = eng.run(prog)\n    s = result.samples\n    \n    # check if a condition is fulfilled \n    # update parameter, go to next iteration, re-run the circuit with new parameter and collect measurment results\n\n", "link": "https://discuss.pennylane.ai//t/circuiterror-the-program-is-locked/3245/1"}, "1": {"author": "isaacdevlugt", "date": "1690840066883", "content": "Hey @Rina!\nShuffling the program creation into where it gets populated \u2014 the function run_circuit \u2014 will do the trick. This will create a new instance of sf.Program every time you call run_circuit, allowing you to feed in different parameters and call it iteratively.\nI also took the liberty of shoving a few other things in the run_circuit function \nshots = 2\nx1 = 0.4\nx2 = 0.5\nparam = [0.1, 0.4, 0.9]\nsteps = 3\n\n\neng = sf.Engine(\"fock\", backend_options={\"cutoff_dim\": 4})\n\n\ndef run_circuit(param):\n    prog = sf.Program(2)\n\n    with prog.context as q:\n        Squeezed(x1) | q[0]\n        Squeezed(x2) | q[1]\n\n        Zgate(-2 * param) | q[0]\n        CZgate(-2 * param) | (q[0], q[1])\n\n        MeasureHomodyne(0.0) | q[0]\n\n    result = eng.run(prog)\n    s = result.samples\n    eng.reset()\n    return s\n\n\nfor j in range(steps):\n    s = run_circuit(param[j])\n\nHope this helps!", "link": "https://discuss.pennylane.ai//t/circuiterror-the-program-is-locked/3245/2"}, "2": {"author": "Rina", "date": "1690867292902", "content": "Thanks a lot, @isaacdevlugt \nI have already tried to return s from inside the run_cisrcuit() but I was getting the same error.\nNow that I compare this simplified code with mine I realised, in my code inside run_cisrcuit(), I am looping over registers to apply some gates and do for example initialization like Squeezed(0.5,0) | q[i], and that is the source of the problem.", "link": "https://discuss.pennylane.ai//t/circuiterror-the-program-is-locked/3245/3"}, "3": {"author": "isaacdevlugt", "date": "1690900573743", "content": "Nice! So, is your problem solved now?", "link": "https://discuss.pennylane.ai//t/circuiterror-the-program-is-locked/3245/4"}, "4": {"author": "Rina", "date": "1690906139257", "content": "Yes, thank you! You can close the question. 2", "link": "https://discuss.pennylane.ai//t/circuiterror-the-program-is-locked/3245/5"}, "5": {"author": "isaacdevlugt", "date": "1690911282079", "content": "Awesome! Glad we could help ", "link": "https://discuss.pennylane.ai//t/circuiterror-the-program-is-locked/3245/6"}, "6": {"author": "Rina", "date": "1690830755940", "content": "Hi,\nI am a bit confused about how to solve the following error CircuitError: The Program is locked, no more Commands can be appended to it. I think I understand why the error happens but  I can\u2019t come up with a way to run the circuit iteratively for a variational algorithm and avoid this error.  The answer here 1 for sampling makes sense. But what about the case when you want to run the circuit iteratively with a new parameter? I tried to eng.reset()  at the end of for loop but it didn\u2019t help.\nI\u2019d appreciate it if you could point out what I am missing here.\nimport strawberryfields as sf\nfrom strawberryfields.ops import *\n\nshots=2\nprog = sf.Program(2)\nx1 = 0.4\nx2 = 0.5\nparam=[0.1, 0.4, 0.9]\nsteps=3\n\n\neng = sf.Engine(\"fock\", backend_options={\"cutoff_dim\": 4})\n\ndef run_circuit(param):\n\n    with prog.context as q:\n\n        Squeezed(x1) | q[0]\n        Squeezed(x2) | q[1]\n\n        Zgate(-2*param) | q[0]\n        CZgate(-2*param) | (q[0],q[1])\n\n        MeasureHomodyne(0.0) | q[0]\n    return \n\nfor j in range(steps):\n    run_circuit(param[j])\n    \n    result = eng.run(prog)\n    s = result.samples\n    \n    # check if a condition is fulfilled \n    # update parameter, go to next iteration, re-run the circuit with new parameter and collect measurment results\n\n", "link": "https://discuss.pennylane.ai//t/circuiterror-the-program-is-locked/3245/7"}}