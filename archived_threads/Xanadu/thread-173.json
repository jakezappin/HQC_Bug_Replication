{"0": {"author": "aouie", "date": "1660143279912", "content": "Hi! I want to make the hybrid model as one without saving the classical NN first and then loading it again and add it in my quantum layer.\nThis is the code for my classical model:\n    def make_residual_lstm_layers(input, rnn_width, rnn_depth, rnn_dropout):\n    \"\"\"\n    The intermediate LSTM layers return sequences, while the last returns a single element.\n    The input is also a sequence. In order to match the shape of input and output of the LSTM\n    to sum them we can do it only for all layers but the last.\n    \"\"\"\n    x = input\n    for i in range(rnn_depth):\n        return_sequences = i < rnn_depth - 1\n        x_rnn = LSTM(rnn_width, recurrent_dropout=rnn_dropout, dropout=rnn_dropout, return_sequences=return_sequences)(x)\n        if return_sequences:\n            # Intermediate layers return sequences, input is also a sequence.\n            if i > 0 or input.shape[-1] == rnn_width:\n                x = add([x, x_rnn])\n            else:\n                # Note that the input size and RNN output has to match, due to the sum operation.\n                # If we want different rnn_width, we'd have to perform the sum from layer 2 on.\n                x = x_rnn\n        else:\n            # Last layer does not return sequences, just the last element\n            # so we select only the last element of the previous output.\n            def slice_last(x):\n                return x[..., -1, :]\n            x = add([Lambda(slice_last)(x), x_rnn])\n    return x\nif __name__ == '__main__':\n    # Example usage\n    from keras.layers import Input\n    from keras.models import Model\n    from keras.layers.merge import add\n    from keras.layers import Lambda\n    input = Input(shape=(X_train.shape[1], X_train.shape[2]))\n    output = make_residual_lstm_layers(input, rnn_width=24, rnn_depth=3, rnn_dropout=0)\n    model = Model(inputs=input, outputs=output)\n    model.summary()\nAnd this is my QNN:\nn_qubits =16\ndev = qml.device(\"lightning.qubit\", wires=n_qubits)\ntf.keras.backend.set_floatx('float64')\n@qml.qnode(dev, diff_method=\"adjoint\")\ndef qnode(inputs, weights):\n    QAOAEmbedding(features=inputs, weights=weights, local_field='Z', wires=range(n_qubits))\n    return [qml.expval(qml.PauliZ(wires=i)) for i in range(n_qubits)]\nn_layers = 1\nweight_shapes = {\"weights\": (n_layers, 20)}\nprint(weight_shapes)\nweights = np.random.random(QAOAEmbedding.shape(n_layers, n_wires=10))\nfeatures = np.array([1., 2.])\nqlayer = qml.qnn.KerasLayer(qnode, weight_shapes, output_dim=n_qubits)\ntf.keras.backend.set_floatx('float64')\nfrom keras.models import load_model\nprev_model = load_model(r\"C:\\Users\\user\\residual.h5\") # loading the previously saved model.\n\nmodel_gru = Sequential()\nmodel_gru.add(prev_model)\nmodel_gru.add(Dense(units=10, activation= 'relu'))\nmodel_gru.add(qlayer)\nmodel_gru.add(Dense(units=24, activation= 'linear'))\nmodel_gru.add(Dense(units=24, activation= 'linear'))\nmodel_gru(X_test[:2])\nmodel_gru.summary()\n\nThank you", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/1"}, "1": {"author": "isaacdevlugt", "date": "1660164340152", "content": "Hey @aouie! Welcome back \nTo make a hybrid model with Keras, you don\u2019t have to save the model, load it back, and then create your hybrid model. Our demo on turning quantum circuits into Keras layers 5 contains an example where everything is defined on the fly (i.e., no classical elements of the network are loaded in).", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/2"}, "2": {"author": "aouie", "date": "1660191654388", "content": "Thank you for this! I tried to add it but I got this error:\n\nTypeError                                 Traceback (most recent call last)\n in \n11     model.add=Dense(units=10, activation= \u2018relu\u2019)\n12     model(X_test[:2])\n\u2014> 13     model.add(qlayer)\n14     model.add(Dense(units=24, activation= \u2018linear\u2019))\n15     model.add(Dense(units=24, activation= \u2018linear\u2019))\n~\\anaconda3\\lib\\site-packages\\keras\\utils\\traceback_utils.py in error_handler(*args, **kwargs)\n65     except Exception as e:  # pylint: disable=broad-except\n66       filtered_tb = _process_traceback_frames(e.traceback)\n\u2014> 67       raise e.with_traceback(filtered_tb) from None\n68     finally:\n69       del filtered_tb\n~\\anaconda3\\lib\\site-packages\\keras\\engine\\input_spec.py in assert_input_compatibility(input_spec, inputs, layer_name)\n194     # have a shape attribute.\n195     if not hasattr(x, \u2018shape\u2019):\n \u2192 196       raise TypeError(f\u2019Inputs to a layer should be tensors. Got: {x}')\n197\n198   if len(inputs) != len(input_spec):\nTypeError: Inputs to a layer should be tensors. Got: \n\nThis is the updated code:\n\nif name == \u2018main\u2019:\nfrom keras.layers import Input\nfrom keras.models import Model\nfrom keras.layers.merge import add\nfrom keras.layers import Lambda\ninput = Input(shape=(X_train.shape[1], X_train.shape[2]))\noutput = make_residual_lstm_layers(input, rnn_width=24, rnn_depth=3, rnn_dropout=0)\nmodel = Sequential(Model(inputs=input, outputs=output))\nmodel.add=Dense(units=10, activation= \u2018relu\u2019)\nmodel.add(qlayer)\nmodel.add(Dense(units=24, activation= \u2018linear\u2019))\nmodel.add(Dense(units=24, activation= \u2018linear\u2019))\nmodel(X_test[:2])\nmodel.summary()\nopt = tf.keras.optimizers.Adam(learning_rate=0.01)\nmodel.compile(opt, loss=\u201cmse\u201d, metrics=[\u201caccuracy\u201d])\nhistory = model.fit(X_train, y_train, epochs=100,validation_data=(X_test, y_test), batch_size=5000, shuffle= True)\n", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/3"}, "3": {"author": "isaacdevlugt", "date": "1660219865407", "content": "It looks like part of your error message got cut off when you copy pasted! Can you resend that? Also, it would be awesome if you could gather a minimal example with inputs and outputs provided just to make sure that I\u2019m able to reproduce your error without fail!", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/4"}, "4": {"author": "aouie", "date": "1660224146641", "content": "Oh, sorry. Here is the error:\nTypeError                                 Traceback (most recent call last)\n in \n11     model.add=Dense(units=10, activation= \u2018relu\u2019)\n12     model(X_test[:2])\n\u2014> 13     model.add(qlayer)\n14     model.add(Dense(units=24, activation= \u2018linear\u2019))\n15     model.add(Dense(units=24, activation= \u2018linear\u2019))\n~\\anaconda3\\lib\\site-packages\\keras\\utils\\traceback_utils.py in error_handler(*args, **kwargs)\n     65     except Exception as e:  # pylint: disable=broad-except\n     66       filtered_tb = _process_traceback_frames(e.__traceback__)\n---> 67       raise e.with_traceback(filtered_tb) from None\n     68     finally:\n     69       del filtered_tb\n\n~\\anaconda3\\lib\\site-packages\\keras\\engine\\input_spec.py in assert_input_compatibility(input_spec, inputs, layer_name)\n    194     # have a `shape` attribute.\n    195     if not hasattr(x, 'shape'):\n--> 196       raise TypeError(f'Inputs to a layer should be tensors. Got: {x}')\n    197 \n    198   if len(inputs) != len(input_spec):\n\nTypeError: Inputs to a layer should be tensors. Got: <Quantum Keras Layer: func=qnode>\n\nAnd for the input, you can use the Iris Dataset and this is how I split it:\n\ndef make_timeseries_instances(timeseries, window_size):\ntimeseries = np.asarray(timeseries)\nirnd = np.random.permutation(timeseries.shape[0]-window_size-24)\nirnd = np.asarray(irnd)\nprint(irnd)\nassert 0 < window_size < timeseries.shape[0]\nX = np.atleast_3d(np.array([timeseries[start:start + window_size] for start in irnd]))\ny = np.atleast_2d(np.array([timeseries[start+window_size+1:start+window_size+25,0] for start in irnd]))\nq = np.atleast_3d([timeseries[-window_size:]])\nprint(\u201cX shape\u201d,X.shape)\nprint(\u201cy shape\u201d,y.shape)\nprint(\u201cq shape\u201d,q.shape)\nreturn X,y,q\nX,y,q = make_timeseries_instances(dataframe,85)\ntest_size = int(0.2 * X.shape[0])\nX_train, X_test, y_train, y_test = X[:-test_size], X[-test_size:], y[:-test_size], y[-test_size:]\nThank you!!!\n", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/5"}, "5": {"author": "isaacdevlugt", "date": "1660312464521", "content": "Hey @aouie! What version of all of your packages are you running? I\u2019m running keras==2.9.0 and pennylane==0.24.0, but I can\u2019t import keras.layers.merge (ModuleNotFoundError).\nMake sure you\u2019re using the right package versions that pennylane requires! I recommend that you make a virtual environment for your project (e.g., with conda: conda create -n my_environment_name python=3.8), then reinstall your packages ", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/6"}, "6": {"author": "isaacdevlugt", "date": "1660565103328", "content": "Hey @aouie! I can\u2019t reproduce your error. I\u2019m able to define dev = qml.device(\"lightning.qubit\", wires=n_qubits) no problem. Can you tell me which version of PennyLane you\u2019re using? You simply need to print qml.__version__.1 Reply", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/7"}, "7": {"author": "aouie", "date": "1660624217774", "content": "\n\n\n isaacdevlugt:\n\nqml.version\n\n\nHi! it is \u20180.24.0\u2019. Same as yours but I don\u2019t know why I get this error.", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/8"}, "8": {"author": "isaacdevlugt", "date": "1660659430532", "content": "Make sure you\u2019re typing qml.__version__ (with the two underscores before and after version) ", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/9"}, "9": {"author": "aouie", "date": "1660791706332", "content": "Hi! I am using pennylane==0.24.0 and keras 2.9.0", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/10"}, "10": {"author": "CatalinaAlbornoz", "date": "1660846085530", "content": "Hi @aouie, from this error it looks like an installation issue. I suggest you follow the following steps on your terminal :\n\nCreate a new virtual environment using: conda create --name my_environment_name python=3.9\n\nMake sure to activate your new environment: activate my_environment_name\n\nCheck your Python version: python3 --version\n\nUpgrade pip: python -m pip install --upgrade pip\n\nInstall Jupyter: python -m pip install jupyter\n\nInstall PennyLane: python -m pip install pennylane\n\nInstall Tensorflow: python -m pip install tensorflow\n\n\nNow open a new Jupyter notebook and code:\nimport pennylane as qml\nimport tensorflow as tf\nqml.about()\nn_qubits =5\ndev = qml.device(\"lightning.qubit\", wires=n_qubits)\n\nIf you get no errors then your problem should be fixed. You should see some version and platform info printed out. If you see an error please post the printed info here, as well as the error. Hopefully this should fix your problem!", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/11"}, "11": {"author": "aouie", "date": "1661007733381", "content": "Hi! Thank you for the help! I followed the steps but I still got the same error.\n\n>     Name: PennyLane\n>         Version: 0.25.1\n>         Summary: PennyLane is a Python quantum machine learning library by Xanadu Inc.\n>         Home-page: https://github.com/XanaduAI/pennylane\n>         Author: \n>         Author-email: \n>         License: Apache License 2.0\n>         Location: c:\\users\\user\\anaconda3\\envs\\nvdia_trial\\lib\\site-packages\n>         Requires: appdirs, autograd, autoray, cachetools, networkx, numpy, pennylane-lightning, retworkx, scipy, semantic-version, toml\n>         Required-by: PennyLane-Lightning\n> \n>         Platform info:           Windows-10-10.0.19043-SP0\n>         Python version:          3.9.12\n>         Numpy version:           1.23.2\n>         Scipy version:           1.9.0\n>         Installed devices:\n>         - default.gaussian (PennyLane-0.25.1)\n>         - default.mixed (PennyLane-0.25.1)\n>         - default.qubit (PennyLane-0.25.1)\n>         - default.qubit.autograd (PennyLane-0.25.1)\n>         - default.qubit.jax (PennyLane-0.25.1)\n>         - default.qubit.tf (PennyLane-0.25.1)\n>         - default.qubit.torch (PennyLane-0.25.1)\n>         - default.qutrit (PennyLane-0.25.1)\n>         - lightning.qubit (PennyLane-Lightning-0.25.0)\n>         ---------------------------------------------------------------------------\n>         ImportError                               Traceback (most recent call last)\n>         Input In [1], in <cell line: 5>()\n>               3 qml.about()\n>               4 n_qubits =5\n>         ----> 5 dev = qml.device(\"lightning.qubit\", wires=n_qubits)\n> \n>         File ~\\anaconda3\\envs\\nvdia_trial\\lib\\site-packages\\pennylane\\__init__.py:309, in device(name, *args, **kwargs)\n>             306 options.update(kwargs)\n>             308 # loads the device class\n>         --> 309 plugin_device_class = plugin_devices[name].load()\n>             311 if Version(version()) not in SimpleSpec(plugin_device_class.pennylane_requires):\n>             312     raise DeviceError(\n>             313         f\"The {name} plugin requires PennyLane versions {plugin_device_class.pennylane_requires}, \"\n>             314         f\"however PennyLane version {__version__} is installed.\"\n>             315     )\n> \n>         File ~\\anaconda3\\envs\\nvdia_trial\\lib\\site-packages\\pkg_resources\\__init__.py:2458, in EntryPoint.load(self, require, *args, **kwargs)\n>            2456 if require:\n>            2457     self.require(*args, **kwargs)\n>         -> 2458 return self.resolve()\n> \n>         File ~\\anaconda3\\envs\\nvdia_trial\\lib\\site-packages\\pkg_resources\\__init__.py:2464, in EntryPoint.resolve(self)\n>            2460 def resolve(self):\n>            2461     \"\"\"\n>            2462     Resolve the entry point from its module and attrs.\n>            2463     \"\"\"\n>         -> 2464     module = __import__(self.module_name, fromlist=['__name__'], level=0)\n>            2465     try:\n>            2466         return functools.reduce(getattr, self.attrs, module)\n> \n>         File ~\\anaconda3\\envs\\nvdia_trial\\lib\\site-packages\\pennylane_lightning\\__init__.py:17, in <module>\n>              14 \"\"\"Top level PennyLane-Lightning module.\"\"\"\n>              16 from ._version import __version__\n>         ---> 17 from .lightning_qubit import LightningQubit\n> \n>         File ~\\anaconda3\\envs\\nvdia_trial\\lib\\site-packages\\pennylane_lightning\\lightning_qubit.py:48, in <module>\n>              45 from ._version import __version__\n>              47 try:\n>         ---> 48     from .lightning_qubit_ops import (\n>              49         adjoint_diff,\n>              50         MeasuresC64,\n>              51         StateVectorC64,\n>              52         MeasuresC128,\n>              53         StateVectorC128,\n>              54         Kokkos_info,\n>              55         allocate_aligned_array,\n>              56         get_alignment,\n>              57         best_alignment,\n>              58     )\n>              60     from ._serialize import _serialize_observables, _serialize_ops\n>              62     CPP_BINARY_AVAILABLE = True\n> \n>         ImportError: DLL load failed while importing lightning_qubit_ops: The specified module could not be found.\n\n", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/12"}, "12": {"author": "CatalinaAlbornoz", "date": "1661194760425", "content": "Hi @aouie. It looks like this is a bug with PennyLane-Lightning under Windows. We are trying to identify the cause now. Thank you for sharing these details!\nIf you do the following, does the problem get fixed?\npython -m pip install pennylane==0.24\npython -m pip install pennylane-lightning==0.24", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/13"}, "13": {"author": "CatalinaAlbornoz", "date": "1661211525536", "content": "Hi @aouie, my colleague Lee has found the source of the problem! Unfortunately the problem is Windows.\nIt seems that the bug was present in v0.24 as well so my previous comment won\u2019t work.\nTo solve the problem you have 2 alternatives:\nA: Revert back to v0.23 using:\npython -m pip install pennylane==0.23\npython -m pip install pennylane-lightning==0.23\n\nB: Shift to Linux by using WSL on your Windows and using Visual Studio Code.\nFollow the guide here\nand use the Linux environment, they can  pip install pennylane  and it should work, getting around the Windows issue for now.\nI hope this helps!", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/14"}, "14": {"author": "aouie", "date": "1661254814646", "content": "Thank you for this! I am using Linux now and it is working with pennylane v0.23. I will get back to you regarding my problem with my hybrid QNN. I really appreciate your help!!", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/15"}, "15": {"author": "CatalinaAlbornoz", "date": "1661291450010", "content": "Hi @aouie, I\u2019m glad you can use lightning now!\nIf you\u2019re on Linux you should be able to use v0.25 if you want.\nYour new error looks like a problem with your inputs.\nAre you able to run this tutorial?\nIf the tutorial runs but not your code then I would suggest making a minimum working example. This involves making a super simple version of your code that runs (or doesn\u2019t run) and that is stripped of anything non essential.\nIn many cases this will lead you to finding the error yourself, and otherwise it can allow us to concentrate on a simpler version of your program. Be sure to share the data you\u2019re using as test and train data so that we can run your example too.", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/16"}, "16": {"author": "CatalinaAlbornoz", "date": "1661528067779", "content": "Hi @aouie, I have great news!\nThe bug that you found has now been fixed in Lightning! \nUpgrading the package should bring in the latest release and enable you to continue.\nThank you for bringing this up!", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/17"}, "17": {"author": "aouie", "date": "1661661745274", "content": "Thank you! I will check into that!", "link": "https://discuss.pennylane.ai//t/how-to-augment-my-quantum-layer-in-my-classical-nn/2096/18"}}